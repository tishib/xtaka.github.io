"use strict";const X_ACL_CONSUMERKEY="8a65991fa76f15df8f4410b4a823c5cee45a5faa64a291d5194d4891f629d793",TOKYO_MARUNOUCHI={lat:35.6822977,lng:139.7650716},SHINJUKU={lat:35.690921,lng:139.7002579},SHIBUYA={lat:35.6592341,lng:139.7000584},LABEL_ORIGIN={x:8,y:4},SVG_AFTER={path:"M4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z",fillColor:isDark()?"#f8f9fa":"#6c757d",fillOpacity:1,strokeWeight:1,strokeColor:"#343a40",rotation:0,scale:5,labelOrigin:null},SVG_BEFORE={path:"M4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z",fillColor:isDark()?"#f8f9fa":"#6c757d",fillOpacity:1,strokeWeight:1,strokeColor:"#343a40",rotation:0,scale:3.5,labelOrigin:null},SVG_AFTER2={path:"M4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z",fillColor:"#0d6efd",fillOpacity:1,strokeWeight:1,strokeColor:"#0d6efd",rotation:0,scale:5,labelOrigin:null},SVG_BEFORE2={path:"M4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z",fillColor:"#0d6efd",fillOpacity:1,strokeWeight:1,strokeColor:"#0d6efd",rotation:0,scale:3.5,labelOrigin:null},PREFIX="pole",ZINDEX_LV=[1e3,2e3,3e3,4e3,5e3],JAEN={ja:{findStation:"近くのバス停を検索",crrTime:" 時点",remainTime:["あと","分"],supportBus:"対応路線",supportBusItems:["都営バス"],title:"バスの到着時間がすぐに分かる - タイムリー"},en:{findStation:"Find Bus Station",crrTime:"As of ",remainTime:["in","min"],supportBus:"Support Bus",supportBusItems:["Toei"],title:"Show the time of bus that will be arriving soon - Timely"}};function isDark(){return!(window.matchMedia&&!window.matchMedia("(prefers-color-scheme: dark)").matches)}function compLatLng(e,t){return Math.floor(100*e)/100==Math.floor(100*t)/100}function dummy1(e){let t=document.createElement("li"),o=document.createElement("img"),a=document.createElement("p"),n=document.createElement("span");t.setAttribute("class","list-group-item"),o.setAttribute("src","./assets/icon_bus_18.svg"),o.setAttribute("alt","busIcon"),o.setAttribute("width","32"),o.setAttribute("height","32"),a.setAttribute("class","text-truncate mb-0"),a.innerText="XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX→XXXXXXXXXXXXXXXXXXXXX",n.setAttribute("class","badge bg-primary"),n.innerText=`${"ja"==usrLang?JAEN.ja.remainTime[0]:JAEN.en.remainTime[0]}     99     ${"ja"==usrLang?JAEN.ja.remainTime[1]:JAEN.en.remainTime[1]}`,e.appendChild(t),t.appendChild(o),t.appendChild(a),t.appendChild(n)}function getToeiBusNameEn(e){let t=e["odpt:startingBusstopPole"].replaceAll("odpt.BusstopPole:Toei.",""),o=e["odpt:terminalBusstopPole"].replaceAll("odpt.BusstopPole:Toei.","");return`${e["odpt:busroute"].replaceAll("odpt.Busroute:Toei.","")} ${t.substring(0,t.indexOf("."))}→${o.substring(0,o.indexOf("."))}`}const bpm=new Map;function fetchBusData(){const e=new XMLHttpRequest;return new Promise((t=>{e.addEventListener("load",(e=>{if(200==e.target.status&&e.target.responseText){const o=JSON.parse(e.target.responseText);for(let e=0;e<o.length;e++){let t=getToeiBusNameEn(o[e]);if(bpm.has(o[e]["odpt:toBusstopPole"])){let a=bpm.get(o[e]["odpt:toBusstopPole"]);a.push({endPole:o[e]["odpt:terminalBusstopPole"],occupancyStatus:o[e]["odpt:occupancyStatus"],fromPole:o[e]["odpt:fromBusstopPole"],fromPoleTime:o[e]["odpt:fromBusstopPoleTime"],id:o[e]["owl:sameAs"],nameJa:o[e]["odpt:note"],routePattern:o[e]["odpt:busroutePattern"],toPole:o[e]["odpt:toBusstopPole"],nameEn:t}),bpm.set(o[e]["odpt:toBusstopPole"],a)}else bpm.set(o[e]["odpt:toBusstopPole"],[{endPole:o[e]["odpt:terminalBusstopPole"],occupancyStatus:o[e]["odpt:occupancyStatus"],fromPole:o[e]["odpt:fromBusstopPole"],fromPoleTime:o[e]["odpt:fromBusstopPoleTime"],id:o[e]["owl:sameAs"],nameJa:o[e]["odpt:note"],routePattern:o[e]["odpt:busroutePattern"],toPole:o[e]["odpt:toBusstopPole"],nameEn:t}])}return t(bpm)}})),e.open("GET",`https://api-tokyochallenge.odpt.org/api/v4/odpt:Bus?odpt:operator=odpt.Operator:Toei&acl:consumerKey=${X_ACL_CONSUMERKEY}`,!0),e.send()}))}const cl=[];function fetchCalendarData(){const e=new XMLHttpRequest;return new Promise((t=>{e.addEventListener("load",(e=>{if(200==e.target.status&&e.target.responseText){const o=JSON.parse(e.target.responseText),a=`${(new Date).getFullYear()}-${((new Date).getMonth()+1).toString().padStart("2",0)}-${(new Date).getDate().toString().padStart("2",0)}`;for(let e=0;e<o.length;e++){let t=o[e]["odpt:day"];for(let n=0;n<t.length;n++)a==t[n]&&cl.push(o[e]["owl:sameAs"])}return t(cl)}})),e.open("GET",`https://api-tokyochallenge.odpt.org/api/v4/odpt:Calendar?odpt:operator=odpt.Operator:Toei&acl:consumerKey=${X_ACL_CONSUMERKEY}`,!0),e.send()}))}const ttm=new Map;function fetchTimeTableData(e,t,o,a){return new Promise((n=>{for(let n=0;n<a.length;n++)if(compLatLng(e.lat,a[n].lat)&&compLatLng(e.lng,a[n].lng)){let e=t.get(a[n].id);if(e)for(let t=0;t<e.length;t++)o.set(e[t].routePattern)}let l=[],r=0;return o.forEach(((e,t,a)=>{l[r]=new XMLHttpRequest,l[r].open("GET",`https://api-tokyochallenge.odpt.org/api/v4/odpt:BusTimetable?odpt:operator=odpt.Operator:Toei&odpt:busroutePattern=${t}&acl:consumerKey=${X_ACL_CONSUMERKEY}`,!0),l[r].addEventListener("load",(e=>{if(200==e.target.status&&e.target.responseText){const a=JSON.parse(e.target.responseText);cl.forEach((e=>{a.forEach((a=>{e!=a["odpt:calendar"]||o.set(t,[a])}))}))}})),l[r].send(),r++})),n(o)}))}const pl2=[];function fetchPoleData2(e){return new Promise((t=>{let o=new XMLHttpRequest;o.open("GET",`https://api-tokyochallenge.odpt.org/api/v4/places/odpt:BusstopPole?lon=${e.lng}&lat=${e.lat}&radius=200&odpt:operator=odpt.Operator:Toei&acl:consumerKey=${X_ACL_CONSUMERKEY}`,!0),o.addEventListener("load",(e=>{if(200==e.target.status&&e.target.responseText){let o=JSON.parse(e.target.responseText);for(let e=0;e<o.length;e++)pl2.push({id:o[e]["owl:sameAs"],lat:o[e]["geo:lat"],lng:o[e]["geo:long"],name:o[e].title});return t(pl2)}})),o.send()}))}var usrLang="";function getRTofTimetable(e,t){let o=0,a=0,n=e.get(t.routePattern);return n&&n[0]["odpt:busTimetableObject"].forEach((e=>{e["odpt:busstopPole"]==t.fromPole&&(o=e["odpt:departureTime"]),e["odpt:busstopPole"]==t.toPole&&(a=e["odpt:arrivalTime"])})),new Date(`01 Jan 1970 ${a}:00 GMT`).getMinutes()-new Date(`01 Jan 1970 ${o}:00 GMT`).getMinutes()||-1}function getRTofCurrent(e){let t=Date.now()-new Date(e.fromPoleTime);return new Date(t).getMinutes()}navigator.language&&(usrLang=navigator.language);const lut=new Map;function calArriveTime(e,t){return getRTofTimetable(e,t)-getRTofCurrent(t)-1}var openFlag=!1;function openFooterMenu(){openFlag||(document.getElementById("footer-menu").style.height="300px",openFlag=!0)}function closeFooterMenu(e){e.preventDefault(),openFlag&&(document.getElementById("footer-menu").style.height="0px",openFlag=!1)}var prevLocMarker=null;function drawLocMarker(e,t,o){o&&(o.visible=!1),prevLocMarker=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},map:t,icon:{url:"./assets/icon_loc.gif"},optimized:!1})}var prevPoleMarker=null;function toggleMarker(e){null!=prevPoleMarker&&prevPoleMarker.get("isSvg2")?prevPoleMarker.setIcon(SVG_BEFORE2):null!=prevPoleMarker&&prevPoleMarker.setIcon(SVG_BEFORE),e.get("isSvg2")?(SVG_BEFORE2.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),SVG_AFTER2.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),e.setIcon(SVG_AFTER2)):(SVG_BEFORE.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),SVG_AFTER.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),e.setIcon(SVG_AFTER)),prevPoleMarker=e}let prevMarkers=[];function drawPoleMarkers(e,t,o,a){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",l=new Map;let r=0;SVG_BEFORE.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),SVG_BEFORE2.labelOrigin=new google.maps.Point(LABEL_ORIGIN.x,LABEL_ORIGIN.y),prevMarkers.forEach((e=>{e.setMap(null),console.log("run")})),prevMarkers=[];for(let s=0;s<pl2.length;s++){compLatLng(e.lat,pl2[s].lat),compLatLng(e.lng,pl2[s].lng);{let e=new google.maps.Marker({animation:google.maps.Animation.DROP,clickable:!0,cursor:"ja"==usrLang?pl2[s].name.ja:pl2[s].name.en,label:{text:n[r++%n.length],color:isDark()?"#212529":"#ffffff"},map:t,position:{lat:pl2[s].lat,lng:pl2[s].lng},title:"ja"==usrLang?pl2[s].name.ja:pl2[s].name.en,visible:!0,icon:a.get(pl2[s].id)?SVG_BEFORE2:SVG_BEFORE,zIndx:ZINDEX_LV[0]});e.addListener("click",(()=>{let t=`[${e.getLabel().text}] ${l.get(e.getLabel().text).pole.name}`,a=document.getElementById("list-bus"),n=l.get(e.getLabel().text).bus;for(document.getElementById("pole").innerText=t;a.firstChild;)a.removeChild(a.firstChild);n&&n.forEach((e=>{let n=document.createElement("li"),l=document.createElement("img"),r=document.createElement("p"),s=document.createElement("span"),i=calArriveTime(o,e,t);n.setAttribute("class","list-group-item"),l.setAttribute("src","./assets/icon_bus_18.svg"),l.setAttribute("alt","busIcon"),l.setAttribute("width","32"),l.setAttribute("height","32"),r.setAttribute("class","text-truncate mb-0"),r.innerText="ja"==usrLang?e.nameJa:e.nameEn,r.id=`pole-${e.id}`,i>1?s.setAttribute("class","badge bg-primary"):i<0?s.setAttribute("class","badge bg-secondary"):s.setAttribute("class","badge bg-danger"),s.innerText=`${"ja"==usrLang?JAEN.ja.remainTime[0]:JAEN.en.remainTime[0]}                 ${i}                 ${"ja"==usrLang?JAEN.ja.remainTime[1]:JAEN.en.remainTime[1]}`,i>-15&&(a.appendChild(n),n.appendChild(l),n.appendChild(r),n.appendChild(s))})),openFooterMenu(),toggleMarker(e)}),!1),l.set(e.getLabel().text,{bus:a.get(pl2[s].id),pole:{id:pl2[s].id,name:"ja"==usrLang?pl2[s].name.ja:pl2[s].name.en}}),a.get(pl2[s].id)&&e.set("isSvg2",1),prevMarkers.push(e)}}drawLocMarker(e,t,prevLocMarker),document.getElementById("btn-close").addEventListener("click",closeFooterMenu,!1);let s=Date.now();document.getElementById("info-as-of").innerText=`${"en-US"==usrLang?JAEN.en.crrTime:""}    ${new Date(s).getHours().toString().padStart(2,"0")}:${new Date(s).getMinutes().toString().padStart(2,"0")}    ${"ja"==usrLang?JAEN.ja.crrTime:""}`}function initLocBtn(e,t){e.textContent=`${"ja"==usrLang?JAEN.ja.findStation:JAEN.en.findStation}`,e.setAttribute("class","btn btn-light shadow-sm p-3 mb-5 bg-white rounded"),e.classList.add("custom-map-control-button"),e.addEventListener("click",(e=>{e.preventDefault(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((async e=>{const o={lat:e.coords.latitude,lng:e.coords.longitude};t.setCenter(o),t.setZoom(17),await fetchPoleData2(o),await fetchTimeTableData(o,bpm,ttm,pl2),await drawPoleMarkers(o,t,ttm,bpm)}),(()=>{}))}),!1)}function initMap(){const e=new google.maps.Map(document.getElementById("map"),{center:{lat:TOKYO_MARUNOUCHI.lat,lng:TOKYO_MARUNOUCHI.lng},zoom:11,streetViewControl:!1,rotateControl:!1,fullscreenControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},disableDefaultUI:!0,keyboardShortcuts:!1,styles:isDark()?[{elementType:"geometry",stylers:[{color:"#212121"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{elementType:"labels.text.stroke",stylers:[{color:"#212121"}]},{featureType:"administrative",elementType:"geometry",stylers:[{color:"#757575"},{visibility:"off"}]},{featureType:"administrative.country",elementType:"labels.text.fill",stylers:[{color:"#9e9e9e"}]},{featureType:"administrative.land_parcel",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#bdbdbd"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#181818"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{featureType:"poi.park",elementType:"labels.text.stroke",stylers:[{color:"#1b1b1b"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#2c2c2c"}]},{featureType:"road",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#8a8a8a"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#373737"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#3c3c3c"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#4e4e4e"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#000000"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#3d3d3d"}]}]:[{featureType:"administrative",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]}]}),t=document.createElement("button");initLocBtn(t,e),e.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(t)}function openSideNav(e){e.preventDefault(),document.getElementById("side-nav").style.width="160px"}function closeSideNav(e){e.preventDefault(),document.getElementById("side-nav").style.width="0px"}function initListener(){document.getElementById("open-side-nav").addEventListener("click",openSideNav,!1),document.getElementById("side-nav").addEventListener("click",closeSideNav,!1),document.getElementById("side-nav").addEventListener("touchmove",closeSideNav,!1)}function initSideNav(){document.getElementById("support-bus-ope").innerText="ja"==usrLang?JAEN.ja.supportBus:JAEN.en.supportBus,document.getElementById("support-bus-toei").innerText="ja"==usrLang?JAEN.ja.supportBusItems[0]:JAEN.en.supportBusItems[0],isDark()&&(document.getElementById("open-side-nav").style.color="#f8f9fa")}async function init(){await fetchBusData(),await fetchCalendarData(),initListener(),initSideNav(),document.title="ja"==usrLang?JAEN.ja.title:JAEN.en.title,isDark()&&(document.getElementById("icon-bug").style.color="#f8f9fa")}function main(){try{init()}catch(e){}}main();
